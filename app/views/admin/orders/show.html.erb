<div class="mb-8 flex items-center gap-4">
  <%= link_to admin_orders_path, class: "p-2 rounded-full bg-white/5 hover:bg-white/10 transition-colors" do %>
    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg>
  <% end %>
  <div>
    <h2 class="text-3xl font-bold mb-1">Order #<%= @order.id %></h2>
    <p class="text-gray-400">Placed on <%= @order.created_at.strftime("%B %d, %Y at %I:%M %p") %></p>
  </div>
</div>

<div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
  <!-- Order Details -->
  <div class="lg:col-span-2 space-y-6">
    <div class="bg-white/5 border border-white/10 rounded-2xl p-6">
      <h3 class="font-bold mb-4">Items</h3>
      <div class="space-y-4 js-order-items-list" data-testid="order-items-list">
        <% @order.order_items.each do |item| %>
          <div class="flex items-center gap-4">
            <div class="w-16 h-16 bg-gray-800 rounded-lg overflow-hidden flex-shrink-0">
              <% if item.product.images.present? %>
                <img src="<%= item.product.images.first %>" class="w-full h-full object-cover" onerror="this.onerror=null;this.src='<%= asset_path('placeholder.svg') %>';">
              <% end %>
            </div>
            <div class="flex-1">
              <h4 class="font-bold"><%= item.product.title %></h4>
              <p class="text-sm text-gray-400">Qty: <%= item.quantity %></p>
            </div>
            <div class="text-right">
              <p class="font-bold"><%= format_price(item.price_at_purchase * item.quantity) %></p>
              <p class="text-xs text-gray-500"><%= format_price(item.price_at_purchase) %> each</p>
              
              <% if @order.status == 'PENDING' %>
                <div class="mt-2 flex items-center justify-end gap-2">
                  <%= form_with(model: [:admin, item], class: "flex items-center gap-2") do |f| %>
                    <%= f.number_field :quantity, min: 1, class: "w-16 bg-black/50 border border-white/20 rounded px-2 py-1 text-xs text-white text-center focus:outline-none focus:border-primary" %>
                    <%= f.button class: "text-primary hover:text-white transition-colors" do %>
                      <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 13.5V4a2 2 0 0 1 2-2h8.5L20 7.5V20a2 2 0 0 1-2 2h-5.5"/><polyline points="14 2 14 8 20 8"/><path d="M10.42 12.61a2.1 2.1 0 1 1 2.97 2.97L7.95 21 4 22l.99-3.95 5.43-5.44Z"/></svg>
                    <% end %>
                  <% end %>
                  
                  <%= button_to admin_order_item_path(item), method: :delete, class: "text-red-500 hover:text-red-400 transition-colors", form: { class: "inline-block" }, data: { turbo_confirm: "Remove this item?" } do %>
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>
                  <% end %>
                </div>
              <% end %>
            </div>
          </div>
        <% end %>
      </div>
      
      <% if @order.status == 'PENDING' %>
        <div class="mt-6 pt-6 border-t border-white/10">
          <h4 class="font-bold mb-4 text-sm uppercase text-gray-400">Add Item</h4>
          <%= form_with(url: admin_order_items_path, scope: :order_item, method: :post, class: "flex gap-4") do |f| %>
            <%= f.hidden_field :order_id, value: @order.id %>
            
            <div class="w-16 h-12 bg-gray-800 rounded-lg overflow-hidden border border-white/10 flex-shrink-0">
              <img id="add_item_preview" src="<%= asset_path('placeholder.svg') %>" class="w-full h-full object-cover" onerror="this.onerror=null;this.src='<%= asset_path('placeholder.svg') %>';">
            </div>

            <div class="flex-1">
              <%= f.select :product_id, Product.where('stock > 0').map { |p| [p.title, p.id, { 'data-image-url': p.images&.first }] }, { prompt: "Select Product" }, class: "w-full bg-black/50 border border-white/20 rounded-lg py-2 px-3 text-white focus:outline-none focus:border-primary", id: "add_item_product_select" %>
            </div>
            <div class="w-24">
              <%= f.number_field :quantity, value: 1, min: 1, placeholder: "Qty", class: "w-full bg-black/50 border border-white/20 rounded-lg py-2 px-3 text-white focus:outline-none focus:border-primary" %>
            </div>
            <%= f.submit "Add", class: "bg-white/10 hover:bg-white/20 text-white font-bold px-6 rounded-lg transition-colors cursor-pointer" %>
          <% end %>
        </div>

        <script>
          document.addEventListener("DOMContentLoaded", function() {
            const select = document.getElementById('add_item_product_select');
            const preview = document.getElementById('add_item_preview');
            const placeholder = '<%= asset_path('placeholder.svg') %>';

            function updatePreview() {
              const selectedOption = select.options[select.selectedIndex];
              const imageUrl = selectedOption.getAttribute('data-image-url');
              
              if (imageUrl) {
                preview.src = imageUrl;
              } else {
                preview.src = placeholder;
              }
            }

            select.addEventListener('change', updatePreview);
          });
        </script>
        </div>
      <% end %>

      <div class="border-t border-white/10 mt-6 pt-4 flex justify-between items-center">
        <span class="text-gray-400">Total</span>
        <span class="text-2xl font-bold text-primary"><%= format_price(@order.total_price) %></span>
      </div>
    </div>
  </div>

  <!-- Sidebar -->
  <div class="space-y-6">
    <!-- Status & Tracking -->
    <div class="bg-white/5 border border-white/10 rounded-2xl p-6">
      <h3 class="font-bold mb-4">Status & Tracking</h3>
      <%= form_with(model: [:admin, @order], class: "space-y-4") do |f| %>
        <div>
          <%= f.label :status, class: "block text-sm text-gray-400 mb-2" %>
          <%= f.select :status, ['PENDING', 'CONFIRMED', 'SHIPPED', 'DELIVERED', 'CANCELLED'], {}, class: "w-full bg-black/50 border border-white/20 rounded-lg py-2 px-3 focus:outline-none focus:border-primary text-white" %>
        </div>
        <div>
          <%= f.label :tracking_number, class: "block text-sm text-gray-400 mb-2" %>
          <%= f.text_field :tracking_number, placeholder: "e.g. EC-12345678", class: "w-full bg-black/50 border border-white/20 rounded-lg py-2 px-3 focus:outline-none focus:border-primary text-white" %>
        </div>
        <div>
          <%= f.label :courier_name, "Courier Name", class: "block text-sm text-gray-400 mb-2" %>
          <%= f.text_field :courier_name, placeholder: "e.g. FedEx, DHL, Blue Dart", class: "w-full bg-black/50 border border-white/20 rounded-lg py-2 px-3 focus:outline-none focus:border-primary text-white" %>
        </div>
        <div>
          <%= f.label :courier_link, "Courier Tracking Link", class: "block text-sm text-gray-400 mb-2" %>
          <%= f.text_field :courier_link, placeholder: "https://www.fedex.com/track", class: "w-full bg-black/50 border border-white/20 rounded-lg py-2 px-3 focus:outline-none focus:border-primary text-white" %>
        </div>
        <%= f.submit "Update Order", class: "w-full bg-primary text-black font-bold py-2 rounded-lg hover:bg-white transition-colors cursor-pointer" %>
      <% end %>
    </div>

    <% if @order.courier_name.present? %>
      <!-- Courier Info -->
      <div class="bg-white/5 border border-white/10 rounded-2xl p-6">
        <h3 class="font-bold mb-4">Courier</h3>
        <div class="space-y-3 text-sm">
          <div>
            <p class="text-gray-400">Courier Name</p>
            <p class="font-bold"><%= @order.courier_name %></p>
          </div>
          <% if @order.courier_link.present? %>
            <div>
              <p class="text-gray-400">Tracking Link</p>
              <a href="<%= @order.courier_link %>" target="_blank" class="text-primary hover:underline">
                Track Package â†’
              </a>
            </div>
          <% end %>
        </div>
      </div>
    <% end %>

    <!-- Customer Info -->
    <div class="bg-white/5 border border-white/10 rounded-2xl p-6">
      <h3 class="font-bold mb-4">Customer</h3>
      <div class="space-y-3 text-sm">
        <div>
          <p class="text-gray-400">Name</p>
          <p><%= @order.customer_name %></p>
        </div>
        <div>
          <p class="text-gray-400">Phone</p>
          <p><%= @order.phone %></p>
        </div>
        <div>
          <p class="text-gray-400">Address</p>
          <p class="whitespace-pre-line"><%= @order.address %></p>
        </div>
      </div>
    </div>
  </div>
</div>
